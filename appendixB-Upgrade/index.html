<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  
  <link rel="shortcut icon" href="../img/favicon.ico">
  <title>Appendix B - Upgrade - Cisco Live 2019 LTRDCN-1572</title>
  <link href='https://fonts.googleapis.com/css?family=Lato:400,700|Roboto+Slab:400,700|Inconsolata:400,700' rel='stylesheet' type='text/css'>

  <link rel="stylesheet" href="../css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../css/theme_extra.css" type="text/css" />
  <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/github.min.css">
  
  <script>
    // Current page data
    var mkdocs_page_name = "Appendix B - Upgrade";
    var mkdocs_page_input_path = "appendixB-Upgrade.md";
    var mkdocs_page_url = null;
  </script>
  
  <script src="../js/jquery-2.1.1.min.js" defer></script>
  <script src="../js/modernizr-2.8.3.min.js" defer></script>
  <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script>
  <script>hljs.initHighlightingOnLoad();</script> 
  
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
      <div class="wy-side-nav-search">
        <a href=".." class="icon icon-home"> Cisco Live 2019 LTRDCN-1572</a>
        <div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
	<ul class="current">
	  
          
            <li class="toctree-l1">
		
    <a class="" href="..">Home</a>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="../intro/">Introduction</a>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="../Task1-ansible-node/">Task 1 - Prepare Ansible node</a>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="../task2-first-ansible/">Task 2 - First Simple Ansible Playbook</a>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="../task3-vxlan-jinja2/">Task 3 - Use of Jinja2 templates with Ansible Playbook</a>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="../task4-vxlan-nxos/">Task 4 - Config switches using Ansible NXOS modules</a>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="../task5-day2-operation/">Task 5 - Day 2 Operations</a>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="../appendixA-F5/">Appendix A - F5</a>
	    </li>
          
            <li class="toctree-l1 current">
		
    <a class="current" href="./">Appendix B - Upgrade</a>
    <ul class="subnav">
            
    <li class="toctree-l2"><a href="#appendix-b-software-compliance-check-and-remediation">Appendix B: Software compliance check and remediation</a></li>
    

    <li class="toctree-l2"><a href="#congratulation-you-have-completed-the-whole-lab">Congratulation! You have completed the whole lab.</a></li>
    

    </ul>
	    </li>
          
        </ul>
      </div>
      &nbsp;
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="..">Cisco Live 2019 LTRDCN-1572</a>
      </nav>

      
      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="..">Docs</a> &raquo;</li>
    
      
    
    <li>Appendix B - Upgrade</li>
    <li class="wy-breadcrumbs-aside">
      
        <a href="https://github.com/fchaudhr/LTRDCN1572.git/edit/master/docs/appendixB-Upgrade.md"
          class="icon icon-github"> Edit on GitHub</a>
      
    </li>
  </ul>
  <hr/>
</div>
          <div role="main">
            <div class="section">
              
                <h1 id="appendix-b-software-compliance-check-and-remediation">Appendix B: Software compliance check and remediation</h1>
<p>In this section, we will run software version compliance check using Ansible. For fabric switch that is not running on standard software version, we will perform software upgrade and bring all fabric switches into the standard version.  </p>
<p>In this playbook, we will use “nxos_facts” to find the software version on each fabric switch. Then we will compare with standard software version, 7.0(3)I7(4) in this lab. For fabric switch that is not running on standard version, the playbook will upgrade and reboot the switch. </p>
<p>On<strong>Atom,</strong> open up the project folder “LTRDCN-1572” and create new file under “LTRDCN-1572”. Name the new file <strong>“code_upgrade.yml”.</strong> </p>
<pre><code class="yaml">---
#Appendix code upgrade
  - hosts: spine,leaf,jinja2_leaf,jinja2_spine
    vars:
      - standard: 7.0(3)I7(4)
      - image_file: nxos.7.0.3.I7.4.bin
      - nxos_provider:
          username: &quot;{{ user }}&quot;
          password: &quot;{{ pwd }}&quot;
          transport: network_cli
          timeout: 30
          host: &quot;{{ inventory_hostname }}&quot;
    tasks:
      - name: &quot;software complaince check&quot;
        nxos_facts:
          gather_subset: all
          provider: &quot;{{nxos_provider}}&quot;
      - name: &quot;change to standard code&quot;
        block:
          - debug: msg=&quot;{{ansible_net_hostname}} is not running standard {{standard}}&quot;
          - nxos_feature:
              feature: scp-server
              provider: &quot;{{nxos_provider}}&quot;
              state: enabled
          - name: &quot;upload image file&quot;
            nxos_file_copy:
              local_file: &quot;/root/downloads/{{image_file}}&quot;
              provider: &quot;{{nxos_provider}}&quot;
          - name: &quot;change boot statement&quot;
            nxos_config:
              lines: boot nxos bootflash:{{image_file}}
              save_when: modified
              provider: &quot;{{nxos_provider}}&quot;
          - name: &quot;reload switch&quot;
            ios_command:
              commands:
                - command: reload
                  prompt: '(y/n)?'
                  answer: 'y'
              username: &quot;{{ user }}&quot;
              password: &quot;{{ pwd }}&quot;
        when: ansible_net_version != standard
        rescue:
          - debug:
              msg: &quot;{{ansible_net_hostname}} is reloading&quot;
          - name: Wait For Device To Come Back Up
            wait_for:
              port: 22
              state: started
              timeout: 900
              delay: 60
              host: &quot;{{ inventory_hostname }}&quot;
        always:
          - debug:
              msg: &quot;All devices are running {{standard}}&quot;
</code></pre>

<p>On the Ansible server, run the playbook for software compliance check and code upgrade. </p>
<p><em>It is expected to see timeout error message when playbook reloads the switch.</em></p>
<hr />
<p><font style= "background-color:  yellow">It is expected to see timeout error message when playbook reloads the switch.</font></p>
<hr />
<p><img alt="" src="pic\b2-1-1.png" /></p>
<hr />
<p><font style= "background-color:  yellow">Switch will take 20 mins to bootup; up to this point, you have completed all tasks.* </font></p>
<hr />
<h1 id="congratulation-you-have-completed-the-whole-lab">Congratulation! You have completed the whole lab.</h1>
              
            </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
      
        <a href="../appendixA-F5/" class="btn btn-neutral" title="Appendix A - F5"><span class="icon icon-circle-arrow-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
    
  </div>

  Built with <a href="http://www.mkdocs.org">MkDocs</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
      
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" style="cursor: pointer">
    <span class="rst-current-version" data-toggle="rst-current-version">
      
          <a href="https://github.com/fchaudhr/LTRDCN1572.git/" class="fa fa-github" style="float: left; color: #fcfcfc"> GitHub</a>
      
      
        <span><a href="../appendixA-F5/" style="color: #fcfcfc;">&laquo; Previous</a></span>
      
      
    </span>
</div>
    <script>var base_url = '..';</script>
    <script src="../js/theme.js" defer></script>
      <script src="../search/main.js" defer></script>

</body>
</html>
